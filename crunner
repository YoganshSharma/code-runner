#!/bin/bash
# shellcheck disable=SC2086

red=$(tput setaf 1)
blue=$(tput setaf 4)
white=$(tput setaf 7)

USAGE="run file -- compiles and executes the executable
run --cc=<compiler> file -- compiles the *.c file with specified compiler
run --cxx=<compiler> file -- compiles the *.cpp file with specified compiler
run --debug file -- compiles the file and pipes it to the specified debugger 
run clean -- removes debug folder, .out and temp files"

_ERROR_UFTC_() {
    echo "${red}ERROR:" "${white}This file type can't be compiled or the file does not exist!"
}

_EXIT_() {
    echo "${blue}Exitting crunner..."
    exit 0
}

default_debugger() {

	KERNEL=$(uname -s)
	if [[ "$KERNEL" == Darwin ]]; then
		debugger="lldb"
	else
		debugger="gdb"
	fi

}

run() {

	default_debugger
    CFLAGS="-Wall"
    if [ "${DEBUG}" = true ]; then
        CFLAGS+=" -g -O0"
    else
        CFLAGS+=" -s -w -O3"
    fi

    if [[ "${FILE#*.}" == c ]]; then
        "${CC:=gcc}" ${CFLAGS} ${FILE} -o "${FILE%%.*}.out"

		if [ "${DEBUG}" = true ]; then
			$debugger "${FILE%%.*}.out"
			rm -rf ./"${FILE%%.*}.out.dSYM"
		else
        	./"${FILE%%.*}.out"
		fi

        rm -rf ./"${FILE%%.*}.out"
    elif [[ "${FILE#*.}" == cpp ]]; then
        "${CXX:=g++}" ${CFLAGS} ${FILE} -o "${FILE%%.*}.out"

		if [ "${DEBUG}" = true ]; then
			$debugger "${FILE%%.*}.out"
			rm -rf ./"${FILE%%.*}.out.dSYM"
		else
        	./"${FILE%%.*}.out"
		fi

        rm -rf ./"${FILE%%.*}.out"
    else
        _ERROR_UFTC_
        _EXIT_
    fi

}

if [[ -z $* ]]; then
    echo "${USAGE}" && exit 0
fi

for arg in "$@"; do
    case "${arg}" in

    "-h" | "--help")
        echo "${USAGE}" && exit 0
        ;;
    *".c" | *".cpp")
        FILE_LOCATION="${arg}"
        if [ ! -f $FILE_LOCATION ]; then
            _ERROR_UFTC_
            _EXIT_
        fi

        if [[ "${FILE_LOCATION}" != */* ]]; then
            FILE="${FILE_LOCATION}"
            run
        else
            LOCATION="${FILE_LOCATION%/*}"
            FILE="${FILE_LOCATION##*/}"
            cd "${LOCATION}" || exit 1
            run
        fi
        ;;
    "--cc="*)
        c="${arg#*=}"
        if [[ -z "$c" ]]; then
            echo "Use --cc=gcc/clang"
        else
            export CC="${c}"
            shift
        fi
        ;;
    "--cxx="*)
        cx="${arg#*=}"
        if [[ -z "$cx" ]]; then
            echo "Use --cxx=g++/clang++"
        else
            export CXX="${cx}"
            shift
        fi
        ;;
    "clean")
        find . -type d -name "*.dSYM" -exec rm -rf {} \; 2>/dev/null
        find . -type f -name "*.out" -exec rm -rf {} \; 2>/dev/null
        rm -rf tempCodeRunnerFile.c
        ;;
    "--debug")
        DEBUG=true
        ;;
    *)
        _ERROR_UFTC_
        _EXIT_
        ;;
    esac
done

